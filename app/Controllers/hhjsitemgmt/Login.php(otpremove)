<?php


class Login extends BaseController {

	public function  __construct() 
	{ 
		
		//error_reporting(E_ALL ^ E_NOTICE);  
		error_reporting(0);  
		$this->admin_model = new AdminModel();
		$this->emailTemplateModel = new EmailtemplateModel();
        $this->smsModel = new SmsModel();
        $this->notificationModel = new NotificationModel();
        $this->common_model = new CommonModel();
        $this->frontModel = new FrontModel();
        $this->layouts = new Layouts();
        $this->session = session();
	 $this->lang = service('language'); 
$this->lang->setLocale('admin');
		helper('common');
	} 
	
	/* * *********************************************************************
	 * * Function name : login
	 * * Developed By : Manoj Kumar
	 * * Purpose  : This function for login
	 * * Date : 23 JUNE 2022
	 * * **********************************************************************/
	public function index()
	{	
		
		if($this->session->get('ILCADM_ADMIN_ID')) redirect($this->session->get('ILCADM_ADMIN_CURRENT_PATH').'maindashboard');
		$data['error'] 						= 	'';
		/*-----------------------------------Login ---------------*/
		if($this->request->getPost('loginFormSubmit')):	
		
			//Set rules
			$this->form_validation->set_rules('userEmail', 'email', 'trim|required');
			$this->form_validation->set_rules('userPassword', 'password', 'trim|required');
			
			if($this->form_validation->run()):	
				$result		=	$this->admin_model->Authenticate($this->request->getPost('userEmail')); 
				if($result): 
					if($this->admin_model->decryptsPassword($result['admin_password']) != $this->request->getPost('userPassword')):
						$data['error'] = lang('statictext_lang.invalidpassword');	
					elseif($result['status'] != 'A'):	
						$data['error'] = lang('statictext_lang.accountblock');	
					else:	

						$param['last_login_ip']				=	currentIp();
					$param['last_login_date']			=	(int)$this->timezone->utc_time();//currentDateTime();
					$param['admin_password_otp']		=	'';
					$this->common_model->editData('admin',$param,'admin_id',$result['admin_id']);

					############	LOGIN IN NEW SYSTEM 	############
					$loginParam['admin_id']				=	(int)$result['admin_id'];
					$loginParam['admin_token']			=	generateToken();
					$loginParam['login_status']			=	'Login';
					$loginParam['login_datetime']		=	(int)$this->timezone->utc_time();//currentDateTime();
					$loginParam['login_ip']				=	currentIp();
					$logininsertId						=	$this->common_model->addData('admin_login_log',$loginParam);

					$currentPath 		=	getCurrentBasePath();
					
					$this->session->set(array(
						'ILCADM_ADMIN_LOGGED_IN'		=>	true,
						'ILCADM_ADMIN_ID'				=>	$result['admin_id'],
						'ILCADM_ADMIN_TITLE'			=>	$result['admin_title'],
						'ILCADM_ADMIN_FIRST_NAME'		=>	$result['admin_first_name'],
						'ILCADM_ADMIN_MIDDLE_NAME'		=>	$result['admin_middle_name'],
						'ILCADM_ADMIN_LAST_NAME'		=>	$result['admin_last_name'],
						'ILCADM_ADMIN_EMAIL'			=>	$result['admin_email'],
						'ILCADM_ADMIN_MOBILE'			=>	$result['admin_phone'],
						'ILCADM_ADMIN_IMAGE'			=>	$result['admin_image'],
						'ILCADM_ADMIN_ADDRESS'			=>	$result['admin_address'],
						'ILCADM_ADMIN_CITY'				=>	$result['admin_city'],
						'ILCADM_ADMIN_STATE'			=>	$result['admin_state'],
						'ILCADM_ADMIN_COUNTRY'			=>	$result['admin_country'],
						'ILCADM_ADMIN_ZIPCODE'			=>	$result['admin_pincode'],
						'ILCADM_ADMIN_TYPE'				=>	$result['admin_type'],
						'ILCADM_ADMIN_CURRENT_PATH'		=>	$currentPath,
						'ILCADM_ADMIN_USER_TYPE'		=>	'',
						'ILCADM_ADMIN_LAST_LOGIN'		=>	$result['last_login_date'].' ('.$result['last_login_ip'].')'));

						setcookie('ILCADM_ADMIN_LOGIN_TOKEN',$loginParam['admin_token'],time()+60*60*24*100,'/');

							if($_COOKIE['ILCADM_ADMIN_REFERENCE_PAGES']):
								redirect(base_url().$_COOKIE['ILCADM_ADMIN_REFERENCE_PAGES']);
							else:
								redirect($currentPath.'maindashboard');
							endif;

					endif;
				else:
					$data['error'] = lang('statictext_lang.invalidlogindetails');
				endif;			
			endif;
		endif;
		
		$this->layouts->set_title('Login');
		$this->layouts->admin_view('account/login',array(),$data,'login');
	}


	/* * *********************************************************************
	 * * Function name : loginverifyotp
	 * * Developed By : Manoj Kumar
	 * * Purpose  : This function used for admin password recover
	 * * Date : 23 JUNE 2022
	 * * **********************************************************************/
	// public function loginverifyotp()
	// {	
	// 	if($this->session->get('ILCADM_ADMIN_ID')) redirect($this->session->get('ILCADM_ADMIN_CURRENT_PATH').'maindashboard');
	// 	$data['error'] 						= 	'';
	// 	$data['recovererror'] 				=	''; 

	// 	/*-----------------------------------recover password ---------------*/
	// 	if($this->request->getPost('otpVerificationFormSubmit')):	
	// 		//Set rules
	// 		$this->form_validation->set_rules('userOtp', 'otp', 'trim|required|min_length[4]|max_length[4]');
			
	// 		if($this->form_validation->run()):	
	// 			$result		=	$this->admin_model->checkOTP($this->request->getPost('userOtp'));
	// 			if($result): 
	// 				$this->session->unset_userdata(array('otpType','otpAdminId','otpAdminMobile'));

	// 				$param['last_login_ip']				=	currentIp();
	// 				$param['last_login_date']			=	(int)$this->timezone->utc_time();//currentDateTime();
	// 				$param['admin_password_otp']		=	'';
	// 				$this->common_model->editData('admin',$param,'admin_id',$result['admin_id']);

	// 				############	LOGOUT IN PRIVIOUS SYSTEM 	#######
	// 				/*
	// 				$logoutParam['admin_token']			=	'';
	// 				$logoutParam['login_status']		=	'Logout';
	// 				$logoutParam['logout_datetime']		=	(int)$this->timezone->utc_time();//currentDateTime();
	// 				$logoutParam['logout_ip']			=	currentIp();

	// 				$logoutuWhere['login_status']		=	'Login';
	// 				$logoutuWhere['admin_id']			=	(int)$result['admin_id'];
	// 				$this->common_model->editDataByMultipleCondition('ILCADM_admin_login_log',$logoutParam,$logoutuWhere);	
	// 				*/
	// 				############	LOGIN IN NEW SYSTEM 	############
	// 				$loginParam['admin_id']				=	(int)$result['admin_id'];
	// 				$loginParam['admin_token']			=	generateToken();
	// 				$loginParam['login_status']			=	'Login';
	// 				$loginParam['login_datetime']		=	(int)$this->timezone->utc_time();//currentDateTime();
	// 				$loginParam['login_ip']				=	currentIp();
	// 				$logininsertId						=	$this->common_model->addData('admin_login_log',$loginParam);

	// 				$currentPath 		=	getCurrentBasePath().'admin/';
	// 				$this->session->set(array(
	// 									'ILCADM_ADMIN_LOGGED_IN'		=>	true,
	// 									'ILCADM_ADMIN_ID'				=>	$result['admin_id'],
	// 									'ILCADM_ADMIN_TITLE'			=>	$result['admin_title'],
	// 									'ILCADM_ADMIN_FIRST_NAME'		=>	$result['admin_first_name'],
	// 									'ILCADM_ADMIN_MIDDLE_NAME'		=>	$result['admin_middle_name'],
	// 									'ILCADM_ADMIN_LAST_NAME'		=>	$result['admin_last_name'],
	// 									'ILCADM_ADMIN_EMAIL'			=>	$result['admin_email'],
	// 									'ILCADM_ADMIN_MOBILE'			=>	$result['admin_phone'],
	// 									'ILCADM_ADMIN_IMAGE'			=>	$result['admin_image'],
	// 									'ILCADM_ADMIN_ADDRESS'			=>	$result['admin_address'],
	// 									'ILCADM_ADMIN_CITY'				=>	$result['admin_city'],
	// 									'ILCADM_ADMIN_STATE'			=>	$result['admin_state'],
	// 									'ILCADM_ADMIN_COUNTRY'			=>	$result['admin_country'],
	// 									'ILCADM_ADMIN_ZIPCODE'			=>	$result['admin_pincode'],
	// 									'ILCADM_ADMIN_TYPE'				=>	$result['admin_type'],
	// 									'ILCADM_ADMIN_CURRENT_PATH'		=>	$currentPath,
	// 									'ILCADM_ADMIN_USER_TYPE'		=>	'',
	// 									'ILCADM_ADMIN_LAST_LOGIN'		=>	$result['last_login_date'].' ('.$result['last_login_ip'].')'));

	// 				setcookie('ILCADM_ADMIN_LOGIN_TOKEN',$loginParam['admin_token'],time()+60*60*24*100,'/');

	// 				if($_COOKIE['ILCADM_ADMIN_REFERENCE_PAGES']):
	// 					redirect(base_url().$_COOKIE['ILCADM_ADMIN_REFERENCE_PAGES']);
	// 				else:
	// 					redirect($currentPath.'maindashboard');
	// 				endif;
	// 			else:
	// 				$data['recovererror'] = lang('statictext_lang.invalidotp');
	// 			endif;
	// 		endif;
	// 	endif;
		
	// 	$this->layouts->set_title('Password Recover');
	// 	$this->layouts->admin_view('account/loginverifyotp',array(),$data,'login');
	// }	// END OF FUNCTION

	/* * *********************************************************************
	 * * Function name : resendotp
	 * * Developed By : Manoj Kumar
	 * * Purpose  : This function used for resend otp
	 * * Date : 23 JUNE 2022
	 * * **********************************************************************/
	public function resendotp()
	{	
		if(sessionData('otpType') && sessionData('otpAdminId') && sessionData('otpAdminMobile')):
			$param['admin_password_otp']	=	(int)'4321';//(int)generateRandomString(4,'n');
			$this->common_model->editData('admin',$param,'admin_id',(int)sessionData('otpAdminId'));

			if(sessionData('otpType') == 'Login'):
				$this->sms_model->sendLoginOtpSmsToUser(sessionData('otpAdminMobile'),$param['admin_password_otp']);
			elseif(sessionData('otpType') == 'Forgot Password'):
				$this->sms_model->sendForgotPasswordOtpSmsToUser(sessionData('otpAdminMobile'),$param['admin_password_otp']);
			elseif(sessionData('otpType') == 'Change Password'):
				$this->sms_model->sendChangePasswordOtpSmsToUser(sessionData('otpAdminMobile'),$param['admin_password_otp']);
			endif;

			$this->session->setFlashdata('alert_success',lang('statictext_lang.sendotptomobile').sessionData('otpAdminMobile'));
		endif;
		redirect($_SERVER['HTTP_REFERER']);
	}	// END OF FUNCTION
	
	/* * *********************************************************************
	 * * Function name : forgotpassword
	 * * Developed By : Manoj Kumar
	 * * Purpose  : This function used for admin forgot password
	 * * Date : 23 JUNE 2022
	 * * **********************************************************************/
	public function forgotpassword()
	{	
		if($this->session->get('ILCADM_ADMIN_ID')) redirect($this->session->get('ILCADM_ADMIN_CURRENT_PATH').'maindashboard');
		$data['error'] 						= 	'';
		$data['forgoterror'] 				= 	'';

		/*-----------------------------------Forgot password ---------------*/
		if($this->request->getPost('recoverformSubmit')):	
			//Set rules
			$this->form_validation->set_rules('forgotMobile', 'Mobile', 'trim|required|min_length[10]|max_length[10]');
			
			if($this->form_validation->run()):	
				$result		=	$this->common_model->getDataByParticularField('admin','admin_phone',$this->request->getPost('forgotMobile'));
				if($result):
					if($result['status'] != 'A'):	
						$data['forgoterror'] = lang('statictext_lang.accountblock');	
					else:
						$param['admin_password_otp']		=	(int)'4321';//(int)generateRandomString(4,'n');
						$this->common_model->editData('admin',$param,'admin_id',(int)$result['admin_id']);

						$this->sms_model->sendForgotPasswordOtpSmsToUser($result['admin_phone'],$param['admin_password_otp']);

						$this->session->set(array('otpType'=>'Forgot Password','otpAdminId'=>$result['admin_id'],'otpAdminMobile'=>$result['admin_phone']));

						$this->session->setFlashdata('alert_success',lang('statictext_lang.sendotptomobile').$result['admin_phone']);
						redirect(getCurrentBasePath().'password-recover');
					endif;
				else:
					$data['forgoterror'] = lang('statictext_lang.invalidmobile');
				endif;
			endif;
		endif;
		
		$this->layouts->set_title('Forgot Password');
		$this->layouts->admin_view('account/forgotpassword',array(),$data,'login');
	}	// END OF FUNCTION

	/* * *********************************************************************
	 * * Function name : passwordrecover
	 * * Developed By : Manoj Kumar
	 * * Purpose  : This function used for admin password recover
	 * * Date : 23 JUNE 2022
	 * * **********************************************************************/
	public function passwordrecover()
	{	
		if($this->session->get('ILCADM_ADMIN_ID')) redirect($this->session->get('ILCADM_ADMIN_CURRENT_PATH').'maindashboard');
		$data['error'] 						= 	'';
		$data['recovererror'] 				= 	'';
		$data['forgotsuccess'] 				= 	'';

		/*-----------------------------------recover password ---------------*/
		if($this->request->getPost('passwordRecoverFormSubmit')):	
			//Set rules
			$this->form_validation->set_rules('userOtp', 'otp', 'trim|required|min_length[4]|max_length[4]');
			$this->form_validation->set_rules('userPassword', 'New password', 'trim|required|min_length[6]|max_length[25]');
			$this->form_validation->set_rules('userConfPassword', 'Confirm password', 'trim|required|min_length[6]|matches[userPassword]');
			
			if($this->form_validation->run()):	
				$result		=	$this->admin_model->checkOTP($this->request->getPost('userOtp'));
				if($result):
					$this->session->unset_userdata(array('otpType','otpAdminId','otpAdminMobile'));

					$param['admin_password']		=	$this->admin_model->encriptPassword($this->request->getPost('userPassword'));
					$param['admin_password_otp']	=	'';
					$this->common_model->editData('admin',$param,'admin_id',(int)$result['admin_id']);
							
					$this->session->setFlashdata('alert_success',lang('statictext_lang.passrecoversuccess'));
					redirect(getCurrentBasePath().'login');
				else:
					$data['recovererror'] = lang('statictext_lang.invalidotp');
				endif;
			endif;
		endif;
		
		$this->layouts->set_title('Password Recover');
		$this->layouts->admin_view('account/passwordrecover',array(),$data,'login');
	}	// END OF FUNCTION
	
	/***********************************************************************
	** Function name : logout
	** Developed By : Manoj Kumar
	** Purpose  : This function used for logout
	** Date : 23 JUNE 2022
	************************************************************************/
	function logout()
	{
		$logoutParam['admin_token']			=	'';
		$logoutParam['login_status']		=	'Logout';
		$logoutParam['logout_datetime']		=	(int)$this->timezone->utc_time();//currentDateTime();
		$logoutParam['logout_ip']			=	currentIp();

		$logoutuWhere['login_status']		=	'Login';
		$logoutuWhere['admin_token']		=	$_COOKIE['ILCADM_ADMIN_LOGIN_TOKEN'];
		$logoutuWhere['admin_id']			=	(int)$this->session->get('ILCADM_ADMIN_ID');
		$this->common_model->editDataByMultipleCondition('admin_login_log',$logoutParam,$logoutuWhere);

		setcookie('ILCADM_ADMIN_LOGIN_TOKEN','',time()-60*60*24*100,'/');
		setcookie('ILCADM_ADMIN_REFERENCE_PAGES','',time()-60*60*24*100,'/');
		
		$this->session->unset_userdata(array('otpType','otpAdminId','otpAdminMobile','changeNewPassword'));
		$this->session->unset_userdata(array('ILCADM_ADMIN_LOGGED_IN',
											 'ILCADM_ADMIN_ID',
											 'ILCADM_ADMIN_TITLE',
											 'ILCADM_ADMIN_FIRST_NAME',
											 'ILCADM_ADMIN_MIDDLE_NAME',
											 'ILCADM_ADMIN_LAST_NAME',
											 'ILCADM_ADMIN_EMAIL',
											 'ILCADM_ADMIN_MOBILE',
											 'ILCADM_ADMIN_IMAGE',
											 'ILCADM_ADMIN_ADDRESS',
											 'ILCADM_ADMIN_CITY',
											 'ILCADM_ADMIN_STATE',
											 'ILCADM_ADMIN_COUNTRY',
											 'ILCADM_ADMIN_ZIPCODE',
											 'ILCADM_ADMIN_TYPE',
											 'ILCADM_ADMIN_CURRENT_PATH',
											 'ILCADM_ADMIN_USER_TYPE',
											 'ILCADM_ADMIN_LAST_LOGIN'));
		redirect(getCurrentBasePath().'admin/login');
	}	// END OF FUNCTION
}